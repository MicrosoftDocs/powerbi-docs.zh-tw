---
title: Power BI Premium 容量記憶體使用與最佳化
description: 了解 Power BI Premium 容量記憶體管理與最佳化。
ms.date: 10/18/2018
ms.topic: conceptual
ms.service: powerbi
ms.subservice: powerbi-admin
ms.author: mblythe
ms.reviewer: mblythe
author: mgblythe
manager: kfile
ms.openlocfilehash: efb0f1dfd340c0defcba8a67e0e46051d0d9be25
ms.sourcegitcommit: c8c126c1b2ab4527a16a4fb8f5208e0f7fa5ff5a
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/15/2019
ms.locfileid: "54293828"
---
# <a name="microsoft-power-bi-premium-capacity-resource-management-and-optimization"></a>Microsoft Power BI Premium 容量資源管理及最佳化

這篇文章說明 Power BI Premium 如何管理資源；也提供範例及疑難排解的建議。 如需概觀，請參閱[什麼是 Power BI Premium？](service-premium.md)。

## <a name="premium-capacity-memory-management"></a>Premium 容量記憶體管理

 耗用 Premium 容量記憶體的項目包括：

* 載入記憶體中的資料集
* 資料集重新整理 (排程及隨選兩種)
* 容量支援的工作負載
* 報表查詢

針對您容量中的發行資料集發出要求時，系統會從永續性儲存體載入該資料集 (也稱為影像載入)。 如果讓資料集在記憶體中保持載入狀態，當未來有對此資料集發出的查詢時，將有助於快速回應查詢。 除了讓資料集在記憶體中保持載入狀態所需的記憶體之外，報表查詢和資料集重新整理也會用到額外的記憶體。

### <a name="dataset-memory-estimation"></a>資料集記憶體預估

嘗試將資料集載入記憶體時，Power BI 會預估資料集會需要多少記憶體，以完成所要求的命令。 資料集在記憶體中的大小通常大於其儲存至磁碟時的大小。 重新整理資料集時，Power BI 至少需要資料集閒置時所需記憶體數量的兩倍。

### <a name="overcommitting-capacity-eviction-and-reloading-of-datasets"></a>超量配置容量、收回及重新載入資料集

Power BI Premium 可提供您「超量配置」容量的優點。 例如，您發佈的資料集數量可以超出容量所能容納的數量。 如果發佈的資料集所需的記憶體數量超出容量中可用的數量，有些資料集會另外儲存在永續性儲存體中。 永續性儲存體是您每個容量相關 100 TB 儲存體的一部分。

那麼，哪些資料集會留在記憶體中，而其他資料集又會發生什麼情況？ 如先前所述，對某個資料集發出要求時，系統會將其載入到記憶體中 (影像載入)。 該要求可能是報表查詢或重新整理作業。 但由於您可以超量配置容量，因此您的容量可能也會面臨記憶體壓力。 當容量面臨記憶體壓力時，節點會從記憶體「收回」一或多個資料集。 非使用中的資料集 (沒有任何正在執行的查詢/重新整理作業) 會優先收回。 然後，依據「最近最少使用的」(LRU) 量值來決定收回的順序。 如果對已收回的資料集發出新的命令，服務就會嘗試將其重新載入記憶體中，而可能收回其他資料集。 此行為會藉由允許容量為超出其記憶體容納限制的資料集提供服務，讓使用上變得更有效率。

將資料集載入到記憶體中是代價非常高昂的作業。 視資料集大小而定，持續時間可能從小型資料集的幾秒鐘，到大型資料集 (例如高達 10 GB) 的數十秒或甚至數分鐘。 Premium 容量會藉由將最近最少使用的資料集儘可能地保留在記憶體中，來嘗試將需要載入容量的次數降到最低。 當需要額外的記憶體時，將必須收回某些資料集，而系統將會嘗試選擇對使用者體驗影響最小的資料集。 當需要額外的記憶體時，將必須收回某些資料集，而系統將會嘗試選擇對使用者體驗影響最小的資料集。 例如，系統會避免收回最近數分鐘內頻繁使用的資料集。 這些資料集可能很快就會再次查詢。

收回程序本身是一項快速作業。 如果資料集在收回時不是處於積極使用的狀態，使用者將無法判斷收回所帶來的影響程度。 不過，如果有太多資料集同時處於活躍狀態，而沒有足夠的記憶體全部予以容納，就可能進行大量收回。 太多使用中資料集可能導致「猛移」(thrashing) 的情況，也就是資料集會不斷地收回再重新載入，而使用者則可能感覺到回應時間明顯變長和效能明顯下降。

### <a name="dataset-refresh-memory-requirement-competing-with-an-active-dataset-memory-requirement"></a>與作用中資料集記憶體需求競爭的資料集重新整理記憶體需求

資料集的重新整理可以依排程進行，或是由使用者視需要進行。 如先前所述，若要進行完整重新整理，所需的記憶體至少為已載入和閒置資料集記憶體大小的兩倍。 在開始重新整理之前，會先預估重新整理記憶體需求。 如果總記憶體需求超出容量中可用記憶體的數量，就會收回部分資料集。 同樣地，收回以 LRU 為依據。

如果即使進行收回也無法取得所需的記憶體，系統就會將重新整理作業排入重試佇列。 服務會進行重試，直到成功或新的重新整理動作開始為止。

如果使用者對容量中的任何資料集發出互動式查詢，但因為重新整理正在進行中而沒有足夠的可用記憶體，該要求就會失敗而必須由使用者重試。

### <a name="workloads"></a>工作負載

根據預設，適用於 **Power BI Premium** 和 **Power BI Embedded** 的容量只支援雲端上與執行中 Power BI 查詢相關聯的工作負載。 我們現在針對兩個額外的工作負載提供預覽支援：**編頁報表**和**資料流程**。 如果啟用，這些工作負載可能就會影響您容量中的記憶體使用量。 如需詳細資訊，請參閱[設定工作負載](service-admin-premium-manage.md#configure-workloads)。

## <a name="cpu-resource-management-in-premium-capacity"></a>Premium 容量中的 CPU 資源管理

CPU 資源的主要取用者有兩個：

* 來自報表的查詢
* 重新整理 (處理中)

### <a name="queries-from-reports"></a>來自報表的查詢

報表查詢會耗用您容量中的 CPU 資源。 若報表有效率不佳的查詢或過多的並行使用者，就可能耗用大量 CPU 資源。 您現有的容量可能不足以處理負載。

### <a name="refresh-parallelization-policy"></a>重新整理平行處理原則

記憶體不是唯一可限制資料集重新整理的資源。 伺服器上的 V 核心數目也可能是一個因素。 由於每個重新整理作業都需要特定數目的 V 核心，因此會限制可平行執行的重新整理數目。 下表會詳細說明每一 SKU 的限制。 系統會將超出這些限制的額外重新整理排入佇列。

 | SKU | 後端 V 核心 | 模型重新整理平行處理原則 |
 | --- | --- | --- |
 | A1  | 0.5  | 1  |
 | A2  | 1  | 2  |
 | A3  | 2  | 3  |
 | A4  | 4  | 6  |
 | A5  | 8  | 12  |
 | A6  | 16  | 24  |
 | EM1  | 0.5  | 1  |
 | EM2  | 1  | 2  |
 | EM3  | 2  | 3  |
 | P1  | 4  | 6  |
 | P2  | 8  | 12  |
 | P3  | 16  | 24  |
 | P4  | 32  | 48  |
 | P5  | 64  | 96  |

 > [!TIP]
> 若您的重新整理發生延遲，請檢查您的容量所支援的平行重新整理數目。

## <a name="example-scenarios"></a>範例案例

以下有幾個常見案例，以及服務所採取的動作：

**一次同時提交二十個排程重新整理**。 Power BI 同時嘗試一次啟動前 *x* 個重新整理。 *x* 的值取決於該 SKU 的重新整理平行處理原則。 如果 Power BI 無法藉由收回非作用中資料集 (最近未使用的資料集) 取得足夠的記憶體，就不會同時啟動所有 *x* 個重新整理。 任何無法啟動的重新整理都會排入佇列，直到能夠啟動為止。

**兩個重新整理同時執行，但記憶體只足以供一個重新整理完成作業**。 能夠完成的重新整理會啟動。 另一個重新整理會稍後進行重試。

**在重新整理數個資料集時，查詢大量的資料集**。 若沒有足夠的記憶體可用，Power BI 會嘗試停用進行中的重新整理，讓互動式的查詢優先進行。 這會降低重新整理的效能。

**資料集要求在目前容量大小重新整理的記憶體太多**。 重新整理會失敗。 系統不會嘗試藉由收回取得更多記憶體。

**重新整理的單一資料集有記憶體暴增情形**。 若該暴增量超出透過收回非使用中資料集所能取得的記憶體數量，系統就會等到稍後有足夠的記憶體來處理暴增量時，才重新嘗試重新整理。

**系統對某個資料集執行查詢，但該資料集無法透過收回所有非使用中中資料集和重新整理來取得足夠的記憶體**。 這些查詢會失敗。 針對這些類型的工作負載需求，應該購買更大的容量。

## <a name="troubleshooting-and-testing"></a>疑難排解與測試

如果報表執行速度很慢或沒有回應，一開始請只使用一個使用者來進行報表測試。 然後開始增加並行使用者負載來找出限制。 在許多情況下，調整您的 DAX 查詢可大幅改變報表的效能。 查詢微調也可增加您的容量所支援的並行使用者數量。 [監視您的容量](service-admin-premium-monitor-capacity.md)以找出潛在的效能問題。

請使用 Azure 中的 Power BI Embedded 容量來測試不同的 SKU，然後判斷最適合您預期工作負載的 Premium SKU。 Power BI Embedded A4 SKU 等同於 P1、A5 = P2 及 A6 = P3。 您可以藉由在 Azure 入口網站中調升或調降規模，在 Azure 中輕鬆切換 SKU。 當您找到最適合您工作負載的 SKU 並已完成測試時，即可刪除該 SKU。

某些情況下，在您的電腦上開啟模型的 Power BI Desktop (.pbix) 檔案並檢查記憶體和 CPU 耗用情況，可提供問題的許多相關資訊。 這對非常大型的模型來說並無助益，但針對一些較小型的模型，請嘗試從您的電腦開啟、重新整理及查詢模型。 當您開啟模型時，請檢查模型大小、記憶體及所耗用的 CPU。 請嘗試重新整理並進行查詢。 請使用工作管理員來檢查本機檔案的 CUP 及記憶體耗用量。 有時，您電腦上的這些計量本身便可透露出較低的 Premium 容量 (例如 P1/ P2) 可能不適合您的解決方案。

## <a name="next-steps"></a>後續步驟

[管理 Power BI Premium 及 Power BI Embedded 內的容量](service-admin-premium-manage.md)