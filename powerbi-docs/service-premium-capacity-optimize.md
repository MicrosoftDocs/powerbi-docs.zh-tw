---
title: 最佳化 Microsoft Power BI Premium 容量
description: 描述 Power BI Premium 容量的最佳化策略。
author: mgblythe
ms.author: mblythe
manager: kfile
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-admin
ms.topic: conceptual
ms.date: 04/09/2019
ms.custom: seodec18
LocalizationGroup: Premium
ms.openlocfilehash: 06712b6bcf57ca84ec03d2c7b99b32ea61ad8c71
ms.sourcegitcommit: 60dad5aa0d85db790553e537bf8ac34ee3289ba3
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/29/2019
ms.locfileid: "65565351"
---
# <a name="optimizing-premium-capacities"></a>最佳化的 Premium 容量

Premium 容量的效能問題發生時，常見的第一個方法是最佳化，或調整您的解決方案，若要還原的可接受的回應時間。 正在以避免購買額外的進階容量，除非對齊基本原理。

需要額外的 Premium 容量時，有這篇文章中所述的兩個選項：

- 相應增加現有的 Premium 容量
- 加入新的 Premium 容量

最後，測試方法和 Premium 容量大小認為這篇文章。

## <a name="best-practices"></a>最佳作法

若要取得最佳的使用率與效能時，有一些建議的最佳作法，包括：

- 使用應用程式工作區，而不個人的工作區。
- 將重要的商務和自助商務智慧 （ssbi） 帶分成不同的容量。

  ![將業務關鍵 」 和 「 自助 BI 分隔成不同的容量](media/service-premium-capacity-optimize/separate-capacities.png)

- 如果只與 Power BI Pro 的使用者共用內容，可能有不需要將內容儲存在專用的容量。
- 當想要達到一個特定的重新整理的時間，或需要特定功能時，請使用專用的容量。 例如，使用大型資料集，或已編頁報告。

### <a name="addressing-common-questions"></a>解決常見的問題

最佳化 Power BI Premium 的部署是一個複雜的主題包含了解工作負載需求、 可用的資源，且其有效使用。

本文說明七個常見的支援問題，說明可能的問題和說明，以及如何找出並解決這些問題的詳細資訊。

### <a name="why-is-the-capacity-slow-and-what-can-i-do"></a>為什麼會變慢，容量和怎麼辦？

有許多原因可能造成慢速的 Premium 容量。 這個問題需要進一步資訊來了解為何慢。 會報告載入速度緩慢？ 或者，它們無法載入？ 速度很慢載入或更新時與報表互動的使用者報表視覺效果嗎？ 會重新整理花費的時間才能完成，或先前發生？

掌握了解原因，您可以接著開始調查。 下列六個問題的回應將會協助您解決多個特定的問題。

### <a name="what-content-is-using-up-my-capacity"></a>內容會佔用我容量？

您可以使用**Power BI Premium 容量計量**篩選的容量，並檢閱工作區內容的效能度量的應用程式。 您可檢閱過去七天內，針對儲存在進階容量內的所有內容的每小時的效能計量和資源使用情況。 監視通常是 Premium 容量效能相關的一般問題的疑難排解時所要採取的第一個步驟。

若要監視的關鍵計量包括：

- 平均 CPU 和使用率過高的計數。
- 平均記憶體使用率過高的計數和特定的資料集、 資料流程，和分頁的報表中的記憶體使用量。
- 作用中的資料集載入記憶體中。
- 平均值和最大的查詢持續時間。
- 平均的查詢等候時間。
- 平均的資料集和資料流程重新整理時間。

在 Power BI Premium 容量度量應用程式中，使用中記憶體會顯示無法被收回，因為它已在過去三分鐘內的使用中的報表所提供的記憶體總量。 重新整理的等候時間高突然增加大型及/或作用中的資料集與相互關聯。

**依平均持續時間的前 5 名**圖表會反白顯示前五個資料集、 編頁的報表，並耗用容量資源的資料流程。 前五個中的內容清單是調查和可能的最佳化候選項目。

### <a name="why-are-reports-slow"></a>為什麼是報告變慢？

下表顯示可能的問題和找出並處理它們的方式。

#### <a name="insufficient-capacity-resources"></a>沒有足夠的容量資源

| 可能的解釋 | 如何找出 | 解決方式 |
| --- | --- | --- |
| 高作用中記憶體總計 （模型不能被收回，因為它是在過去三分鐘內的使用中）。<br><br> 在查詢中的多個高尖峰等候時間。<br><br> 重新整理中的多個高尖峰等候時間。 | 監視記憶體計量\[ [1](#endnote-1)\]，和收回計數\[ [2](#endnote-2)\]。 | 減少模型大小，或將轉換成 DirectQuery 模式。 請參閱[最佳化模型](#optimizing-models)這篇文章中的區段。<br><br> 相應增加容量。<br><br> 將內容指派至不同的容量。 |

#### <a name="inefficient-report-designs"></a>效率不佳的報表設計

| 可能的解釋 | 如何找出 | 解決方式 |
| --- | --- | --- |
| 報表頁面包含太多的視覺效果 （互動式篩選可觸發每個視覺效果傳送至少一個查詢）。<br><br> 視覺效果會擷取超過所需的更多資料。 | 檢閱報表設計。<br><br> 訪談報表使用者，若要了解它們如何與報表互動。<br><br> 監視資料集查詢計量\[ [3](#endnote-3)\]。 | 使用較少的視覺效果，每個頁面的重新設計報表。 |

#### <a name="dataset-is-slow-especially-when-reports-have-previously-performed-well"></a>資料集是很慢，特別是當報告先前已順利執行

| 可能的解釋 | 如何找出 | 解決方式 |
| --- | --- | --- |
| 不斷擴大的大量匯入資料的詳細資訊。<br><br> 複雜或效率不佳的計算邏輯，包括 RLS 角色。<br><br> 不完全最佳化的模型。<br><br> (DQ/LC)閘道的延遲。<br><br> DQ 來源查詢回應時間很慢。 | 檢閱模型的設計。<br><br> 監視閘道效能計數器。 | 請參閱[最佳化模型](#optimizing-models)這篇文章中的區段。 |

#### <a name="high-concurrent-report-usage"></a>高並行的報表使用情況

| 可能的解釋 | 如何找出 | 解決方式 |
| --- | --- | --- |
| 高查詢等候時間。<br><br> CPU 飽和。<br><br> 超過 DQ/LC 連線限制。 | 監視 CPU 使用率\[ [4](#endnote-4)\]，查詢等候時間和 DQ/LC 使用率\[ [5](#endnote-5) \]計量 + 查詢持續時間。 如果出現變動，可能表示並行處理問題。 | 相應增加容量，或將內容指派給不同的容量。<br><br> 使用較少的視覺效果，每個頁面的重新設計報表。 |

**附註：**    
<a name="endnote-1"></a>\[1\]平均記憶體使用量 (GB) 和最高記憶體耗用量 (GB)。   
<a name="endnote-2"></a>\[2\]資料集區收回。   
<a name="endnote-3"></a>\[3\]資料集查詢，資料集平均查詢持續時間 （毫秒），資料集的 Wait 計數，以及資料集的平均等候時間 （毫秒）。   
<a name="endnote-4"></a>\[4\] CPU 高使用量計數和 CPU 時間的最高使用量 （過去七天）。   
<a name="endnote-5"></a>\[5\] DQ/LC 高使用率的計數和 DQ/LC 時間最高使用量 （過去七天）。   

### <a name="why-are-reports-not-loading"></a>為何報表無法載入嗎？

無法載入報表，就沒有足夠的記憶體容量，以及是過度加熱確定登。 這可能是載入的所有模型會主動查詢，而因此無法被收回，且任何重新整理作業已暫停或延遲。 Power BI 服務會嘗試將資料集載入 30 秒，而且使用者依正常程序通知而失敗的建議，請稍後再試。

目前沒有任何計量來監視報表載入失敗。 您可以監視的系統記憶體，特別是最高使用率和最高使用量的時間，以識別此問題的可能性。 高的資料集區收回和長時間的資料集重新整理的平均等候時間可能會建議，發生此問題。

如果發生這種情況非常偶爾才，這可能不會視為優先性的問題。 服務忙碌中，而它們應該在一小段時間後重試，則報表使用者會收到通知。 如果發生這種情況頻率太高，就可以解決問題向上調整進階容量，或將內容指派給不同的容量。

容量管理員 （及 Power BI 服務系統管理員） 可以監視**查詢失敗**計量，以判斷當發生這種情況。 它們也可以重新啟動的容量，重設系統超載時的所有作業。

### <a name="why-are-refreshes-not-starting-on-schedule"></a>為什麼重新整理不啟動排程？

不保證已排程的重新整理開始時間。 您應該記得，在 Power BI 服務將一律排定優先順序互動式作業透過背景作業。 重新整理是兩個條件符合時，可能會發生在背景作業：

- 沒有足夠的記憶體
- 未超過支援的並行重新整理 Premium 容量的數目

當不符合條件時，重新整理已排入佇列，直到條件為有利。

完整的重新整理，您應該記得至少兩倍目前的資料集的記憶體大小是必要項。 如果找不到有足夠的記憶體，然後無法開始重新整理，直到模型收回會釋出記憶體-這表示一個或多個資料集變成非作用中且可收回之前的延遲。

回想一下，支援的最大並行重新整理數目設定為 1.5 倍後端 v 核心，無條件進位。

時無法開始進行下一個排定的重新整理到期開始之前，排程的重新整理將會失敗。 從 UI 手動觸發依需求重新整理會嘗試執行而失敗之前最多三次。

容量管理員 （及 Power BI 服務系統管理員） 可以監視**平均重新整理等候時間 （分鐘）** 計量來判斷已排程的時間和作業的開始之間的平均延遲。

雖然通常不會重新整理系統管理的優先順序，來影響在工作階段資料，確保有足夠的記憶體。 這可能牽涉到隔離資料集加入至已知的資源不足，無法使用的容量。 此外，也可以幫助您交錯進行，或減少排程的資料重新整理時間，以減少衝突的資料集擁有者可以協調系統管理員。 請注意，不可能讓系統管理員來檢視重新整理佇列，或擷取資料集的排程。

### <a name="why-are-refreshes-slow"></a>為何會變慢的重新整理？

重新整理可能會很緩慢-認知會變慢 （如先前的一般問題位址）。

當重新整理事實上很慢時，它可以是由多種原因造成：

- CPU 資源不足 （重新整理可以是非常耗用 CPU 資源）。
- 記憶體不足，導致重新整理暫停 （這需要條件何時有利於 recommence 從頭開始重新整理）。
- 非容量考量，包括資料來源系統回應能力、 網路延遲、 無效的權限或閘道的輸送量。
- 資料磁碟區-的好理由，若要設定累加式重新整理，如下所述。

容量管理員 （及 Power BI 服務系統管理員） 可以監視**平均的重新整理期間 （分鐘）** 計量來判斷的基準測試來比較經過一段時間，而**平均重新整理等候時間 （分鐘）** 度量，以判斷之間的平均延遲平均排定的時間與作業的開始之間的延遲。

累加式重新整理可以大幅降低資料重新整理的持續時間，特別是針對大型模型資料表。 有四個累加式重新整理相關聯的優點：

- **重新整理會更快**-資料表的子集需要載入，減少 CPU 和記憶體使用量，並重新整理多個資料分割時，平行處理原則可能會高。
- **只在需要時，就會發生重新整理**-累加式重新整理原則可以設定為載入只有當資料已變更。
- **重新整理會更可靠**-變動性的資料來源系統的短執行連線會較不容易發生中斷連線。
- **模型保持修剪**-累加式重新整理原則可以設定為自動移除記錄超過滑動視窗的時間。

若要進一步了解，請參閱[累加式重新整理 Power BI Premium 中](service-premium-incremental-refresh.md)。

### <a name="why-are-data-refreshes-not-completing"></a>原因是資料重新整理未完成？

當資料重新整理開始，但無法完成時，它可以是由多種原因造成：

- 記憶體不足，即使在 Premium 容量中，只有一個模型也就是模型大小會非常大。
- 非容量考量，包括資料來源系統中斷連線 」、 「 不正確的權限或 「 閘道 」 錯誤。

容量管理員 （及 Power BI 服務系統管理員） 可以監視**重新整理失敗因記憶體不足**計量。

## <a name="optimizing-models"></a>最佳化模型

最佳的模型設計，請務必提供一個有效率且可調整的解決方案。 不過，已超出本文，以提供完整的討論範圍。 相反地，這一節將提供重點考量最佳化模型時。

### <a name="optimizing-power-bi-hosted-models"></a>最佳化的 Power BI 裝載模型

最佳化裝載於 Premium 容量中的模型可以達成的資料和模型層。

請考慮匯入模型的最佳化可能性：

![匯入模型的最佳化可能性](media/service-premium-capacity-optimize/import-model-optimizations.png)

在資料來源層中：

- 關聯式資料來源可以透過預先整合的資料，套用適當的索引，累加式重新整理期間，定義對齊的資料表資料分割和具體化計算最佳化以確保最快速的可能重新整理 （取代計算建立資料表和資料行的模型） 或計算邏輯新增至檢視。
- 與關聯式存放區，可以預先整合的非關聯式資料來源。
- 確定閘道具有足夠的資源，最好是在專用的機器，具有足夠的網路頻寬和接近資料來源。

在模型層：

- Power Query 查詢的設計可以最小化或移除複雜的轉換，尤其是合併不同資料來源 （資料倉儲達到此目的在其擷取-轉換-載入 」 階段）。 此外，確保該適當的資料來源的隱私權等級設定，這可以避免需要 Power BI 載入完整的結果，以產生在查詢之間的合併的結果。
- 模型結構決定要載入的資料，並會直接影響模型大小。 它可設計以避免載入不必要的資料，藉由移除資料行、 移除資料列 （尤其是當歷史資料），或藉由載入摘要的資料 （但會犧牲正在載入詳細的資料）。 可藉由移除高基數的資料行 （尤其是文字資料行） 不會儲存或壓縮非常有效率的方式設定了大幅的大小縮減。
- 藉由設定單向關聯性，除非有充足的理由来允許雙向篩選，可以改善模型的查詢效能。 請考慮[CROSSFILTER](https://docs.microsoft.com/dax/crossfilter-function)函式，而不是雙向篩選。
- 能夠快速查詢回應載入預先摘要的資料，彙總資料表，不過這樣會增加模型和結果的大小，在較長的重新整理時間。 一般而言，彙總資料表應該保留非常大的模型或複合模型設計。
- 導出的資料表和資料行增加模型大小，並導致較長的重新整理時間。 一般而言，較小的儲存體大小和更快的重新整理時可達成時具體化或導出資料來源中的資料。 如果這不可行，則使用 Power Query 自訂資料行可以提供改善的存放區壓縮。
- 可能有機會來微調 RLS 規則，可能重新撰寫邏輯，以避免昂貴的公式的量值的 DAX 運算式
- 累加式重新整理可以大幅減少重新整理時間，並節省記憶體和 CPU。 若要移除保留模型大小修剪的歷史資料也可以設定累加式重新整理。
- 模型無法重新設計為兩個模型，有不同，衝突的查詢模式時。 比方說，有些報表有高層級彙總所有歷程記錄，而且可以透過允許 24 小時的延遲。 其他報表關心的今天的資料，並需要細微存取個別的交易。 而不是設計來滿足所有報表的單一模型，建立適用於每個需求的兩個模型。

請考慮為 DirectQuery 模型最佳化可能性。 模型對基礎資料來源發出查詢要求，資料來源的最佳化是傳遞回應模型查詢的關鍵。

 ![DirectQuery 模型最佳化可能性](media/service-premium-capacity-optimize/direct-query-model-optimizations.png)

在資料來源層中：

- 資料來源可以最佳化以確保最快可以查詢透過預先整合的資料 （也就是不可能在模型層），將套用適當的索引，定義資料表資料分割，具體化摘要的資料 （與索引檢視表），以及計算數量降至最低。 傳遞查詢必須只篩選，並執行索引的資料表或檢視之間的內部聯結時，被達成最佳的體驗。
- 確定閘道具有足夠的資源，最好是在專用的機器，具有足夠的網路頻寬和接近資料來源。

在模型層：

- 設計應該最好是會套用任何轉換，而 power Query 查詢否則會嘗試將轉換成 「 絕對最小值。
- 藉由設定單向關聯性，除非有充足的理由来允許雙向篩選，可以改善模型的查詢效能。 此外，關聯性模型應該設定為假設 （這種情況時），強制執行參考完整性，而會使用更有效率的內部聯結 （而不外部聯結） 的資料來源查詢中。
- 避免建立 Power Query 查詢自訂資料行或模型的導出資料行-具體化這些資料來源，可能的話。
- 可能有機會來微調 RLS 規則，可能重新撰寫邏輯，以避免昂貴的公式的量值的 DAX 運算式。

請考慮最佳化可能性的複合模型。 您應該記得複合模型可讓各種匯入和 DirectQuery 的資料表。

![最佳化可能性的複合模型](media/service-premium-capacity-optimize/composite-model-optimizations.png)

- 一般而言，匯入和 DirectQuery 模型最佳化適用於使用這些儲存模式的複合模型資料表。
- 一般而言，為雙重的儲存體模式和事實類型資料表 （通常是大型資料表，表示作業的事實） 就可以獲得平衡的設計藉由設定維度類型資料表 （代表商業實體），做為 DirectQuery 儲存模式。 雙重的儲存模式表示同時匯入和 DirectQuery 儲存模式，而這可讓 Power BI 服務，以判斷產生傳遞的原生查詢時要使用最有效率的儲存模式。
- 請確定閘道有足夠的資源，最好是在專用的機器，具有足夠的網路頻寬和接近資料來源
- 彙總資料表設定為匯入儲存體模式可以提供大幅的查詢效能增強功能時用來彙總 DirectQuery 儲存模式的事實類型資料表。 在此情況下，彙總資料表將會增加模型的大小，並增加重新整理時間，並通常這是可接受的取捨，加快查詢的功能。

### <a name="optimizing-externally-hosted-models"></a>最佳化外部裝載模型

中所討論的許多最佳化可能性[最佳化的 Power BI 裝載模型](#optimizing-power-bi-hosted-models)區段也同樣適用於開發與 Azure Analysis Services 和 SQL Server Analysis Services 的模型。 清除例外狀況，是目前不支援，包括複合模型和彙總資料表特定功能。

外部裝載的資料集的另一項考量是相對於 Power BI 服務中裝載的資料庫。 Azure Analysis services，這表示 Power BI 租用戶 （主要區域） 位於相同區域中建立 Azure 資源。 SQL Server Analysis services，iaas，這表示裝載在相同區域中，VM 與內部，它的目的是確保有效的閘道安裝程式。

順帶一提，它可能是感興趣，請注意，Azure Analysis Services 資料庫和 SQL Server Analysis Services 表格式資料庫需要其模型可完全載入到記憶體，以支援查詢，它們保留在所有時間。 Power BI 服務，例如需要足夠的記憶體，如果在重新整理期間，模型必須保持 online 重新整理。 不同於 Power BI 服務中，沒有概念模型會自動過時流入和流出根據使用的記憶體。 Power BI Premium，因此，提供更有效率的方式，以最大化查詢使用較低的記憶體使用量的模型。

## <a name="capacity-planning"></a>容量規劃

進階容量的大小會決定其可用的記憶體和處理器資源和容量加諸的限制。 Premium 容量的數目也會考量，以建立多個進階容量可以協助找出彼此的工作負載。 請注意，儲存體是 100 TB，每個容量節點，這是很多個足夠的任何工作負載。

決定的大小和數目的 Premium 容量可能相當困難，特別是針對您所建立的初始容量。 第一個步驟是要了解代表預期的每日使用量的平均工作負載的容量大小設定。 請務必了解，並非所有的工作負載會相等。 例如其中一端-100 個並行的使用者存取單一報表頁面，其中包含單一視覺效果是範圍的輕鬆就可達成的。 -另一端的範圍-100 位並行使用者，存取不同的 100 份報表，每個都具有 100 的視覺效果在報表頁面上，將會讓容量資源非常不同的需求。

容量管理員，因此必須考慮許多因素，包括特定對您的環境、 內容和預期的使用方式。 覆寫的目的是要最大化容量使用率，同時提供一致的查詢時間、 可接受的等候時間和收回率。 考量因素包括：

- **模型大小和資料的特性**-匯入模型必須是完全載入記憶體，讓查詢或重新整理。 LC/DQ 資料集可能需要相當多的處理器時間和評估複雜的量值或 RLS 規則可能是嚴重的記憶體。 記憶體和處理器大小和 LC/DQ 查詢輸送量會受限於容量大小。
- **並行作用中的模型**-不同的匯入模型的並行查詢提供最佳的回應速度及效能時它們留在記憶體中。 應該要有足夠的記憶體來裝載所有大量查詢的模型，使用額外的記憶體，以允許其重新整理。
- **匯入模型重新整理**-重新整理類型 （完整或累加）、 持續時間和 Power Query 查詢與導出的資料表/資料行的邏輯的複雜性可能會影響記憶體和特別的處理器使用量。 並行重新整理會受限於容量大小 （1.5 x backend v 核心，無條件進位）。
- **並行查詢**-可能會造成許多並行查詢，在沒有回應會報告當處理器或 LC/DQ 連線超過容量限制。 這是特別針對包含許多視覺效果的報表頁面。
- **資料流程和編頁報表**-容量可以設定為支援資料流程和分頁的報表中，每個要求的可設定的最大容量的記憶體百分比。 記憶體以動態方式配置給資料流程，但以靜態方式配置給分頁報表。

除了這些因素，容量管理員可以考慮建立多個的容量。 多項職能，允許的工作負載隔離，而且可以設定以確保優先權工作負載都有保證的資源。 比方說，可以建立兩個的容量，來分開自助商務智慧 （ssbi） 帶工作負載的商務關鍵性工作負載。 商務關鍵性容量可用來找出大型公司的模型，並提供保證的資源，而撰寫的 IT 部門只授與存取權。 SSBI 容量可用來裝載具有存取權授與商務分析師的較小的模型，且數目不斷增加。 SSBI 容量有時可能會遇到查詢或重新整理是可容忍的等候。

經過一段時間，容量管理員就可以平衡工作區容量跨工作區或容量之間的工作區之間移動內容，以及相應增加或減少容量。 一般而言，主應用程式更大的模型您相應增加和更高的並行存取您相應放大。

您應該記得，購買的授權提供給租用戶的 v 核心。 購買**P3**訂用帳戶可用來建立一個，或最多四個進階容量，也就是 P3，或 x P2，2 或 4 x 1 x P1。 此外，轉換 P2 容量 P3 容量之前, 的考量可以提供給分割的 v 核心來建立兩個 P1 容量。

## <a name="testing-approaches"></a>測試方法

容量大小是一旦決定後，執行測試，可以藉由建立受控制的環境。 實用又經濟的選項是建立 Azure (Sku) 容量是 P1 容量相同的大小為 A4 容量，為 p2 和 P3 容量相同的大小 A5 和 A6 容量，分別。 Azure 的容量可以快速建立，並每小時計費。 因此，測試完成之後，您可以輕鬆地刪除停止產生成本。

測試內容可以新增至 Azure 的容量，在建立工作區，然後以單一使用者可以執行報表，以產生實際的代表性工作負載的查詢。 匯入模型時，應該也執行每個模型的重新整理。 監視工具則可用來檢閱所有的計量，以了解資源使用率。

請務必測試是可重複。 測試應執行數次，它們應該提供大約相同的結果每次。 這些結果的平均值可進行推斷，並評估條件，則為 true 的生產環境工作負載。

若要產生的壓力測試，請考慮開發負載測試模擬實際的工作負載的應用程式。 如何達成此目的的細節已超出本文的範圍。 如需詳細資訊包括的程式碼範例，請參閱[Power BI 應用程式負載測試使用 Visual Studio 負載測試](https://blogs.msdn.microsoft.com/charles_sterling/2018/04/04/webinar-load-testing-power-bi-applications-with-visual-studio-load-test/)網路研討會。

## <a name="acknowledgements"></a>通知

撰寫本文時已由 Peter Myers、 資料平台 MVP 和獨立 BI 專家[位元解決方案](https://www.bitwisesolutions.com.au/)。

## <a name="next-steps"></a>後續步驟

> [!div class="nextstepaction"]
> [Premium 容量案例](service-premium-capacity-scenarios.md)   
  
有其他問題嗎？ [嘗試在 Power BI 社群提問](https://community.powerbi.com/)

||||||